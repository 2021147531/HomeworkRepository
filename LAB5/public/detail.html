<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <title>ì˜í™” ìƒì„¸ í˜ì´ì§€</title>
    <link rel="stylesheet" type="text/css" href="/main.css">
</head>
<body>
    <div class="container">
        <!-- ì œëª© -->
        <div class="title-holder">
            <h1 class="title">ì¸í”„ë° ì˜í™” ì •ë³´ ì‚¬ì´íŠ¸ì…ë‹ˆë‹¤.</h1>
        </div>

        <!-- ë„¤ë¹„ê²Œì´ì…˜ ë°” -->
        <div class="nav">
            <a href="/index.html" class="current-page">ë©”ì¸í˜ì´ì§€</a>
            <a href="/login.html">ë¡œê·¸ì¸</a>
            <a href="/signup.html">íšŒì›ê°€ì…</a>
        </div>

        <!-- ìƒì„¸ ì •ë³´ ì˜ì—­ -->
        <div id="movie-detail"></div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // movie idë¥¼ ì¶”ì¶œ
            const pathParts = window.location.pathname.split("/");
            const id = pathParts[pathParts.length - 1];

            // ëŒ“ê¸€ ë¶ˆëŸ¬ì˜¤ê¸°
            function loadComments() {
                fetch(`/comments/${id}`)
                    .then(res => {
                        if (!res.ok) throw new Error("ëŒ“ê¸€ ë¡œë”© ì‹¤íŒ¨");
                        return res.json();
                    })
                    .then(comments => {
                        const commentList = document.getElementById("comment-list");
                        commentList.innerHTML = comments.map(c => `<p>${c}</p>`).join("");
                    })
                    .catch(err => {
                        const commentList = document.getElementById("comment-list");
                        commentList.innerHTML = `<p style="color:red;">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>`;
                    });
            }

            // ì˜í™” ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°
            fetch(`/movie/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error("ì˜í™” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                    return res.json();
                })
                .then(movie => {
                    const detail = document.getElementById("movie-detail");
                    detail.innerHTML = `
                        <div class="detail-box">
                            <div class="detail-layout">
                                <img src="/images/${movie.movie_image}" alt="${movie.movie_title}" class="detail-poster">
                                <div class="detail-info">
                                    <p><strong>ì˜í™” id:</strong> ${movie.movie_id}</p>
                                    <h2>ğŸ¬ ì˜í™” ì œëª©: ${movie.movie_title}</h2>
                                    <p>ğŸ“… <strong>ê°œë´‰ì¼:</strong> ${movie.movie_release_date}</p>
                                    <p>â­ <strong>í‰ì :</strong> ${movie.movie_rate}</p>
                                    <p>ğŸ“– <strong>ì¤„ê±°ë¦¬:</strong> ${movie.movie_overview}</p>
                                </div>
                            </div>
                            <div class="detail-comments">
                                <h3>ğŸ“ ì˜í™” í›„ê¸°</h3>
                                <div id="comment-list"></div>
                                <form id="comment-form">
                                    <input type="text" id="comment-input" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required style="width: 80%; padding: 8px;">
                                    <button type="submit" style="padding: 8px 12px;">ì‘ì„±</button>
                                </form>
                            </div>
                        </div>
                    `;
                    loadComments();
                })
                .catch(err => {
                    document.getElementById("movie-detail").innerText = "ì˜í™” ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                });

            
            // ëŒ“ê¸€ ì‘ì„±ì„ ìœ„í•œ ì´ë²¤íŠ¸
            document.addEventListener("submit", (e) => {
                if (e.target.id === "comment-form") {
                    e.preventDefault();
                    const input = document.getElementById("comment-input");
                    const comment = input.value.trim();
                    if (!comment) return;

                    fetch(`/comments/${id}`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ comment })
                    })
                    .then(res => res.json())
                    .then(() => {
                        input.value = "";
                        loadComments();
                    });
                }
            });
        });
    </script>
</body>
</html>
